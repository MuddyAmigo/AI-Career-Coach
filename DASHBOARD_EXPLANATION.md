# Dashboard System Explanation

## Overview

The AI Career Coach dashboard displays weekly-refreshed industry insights generated by Google's Gemini AI. This document explains how the entire system works.

---

## üîÑ Data Flow Architecture

```
User Onboarding
    ‚Üì
Select Industry ‚Üí Generate AI Insights (Gemini) ‚Üí Store in Database
    ‚Üì                                                       ‚Üì
Display on Dashboard ‚Üê Fetch Insights ‚Üê Check if Needs Update
    ‚Üì
Weekly Cron Job (Inngest) ‚Üí Regenerate Insights ‚Üí Update Database
```

---

## üìÅ Key Files & Their Roles

### 1. **`actions/user.js`** - User Profile Management

```javascript
export async function updateUser(data)
```

**What it does:**

- Called when user completes onboarding form
- Checks if industry insights exist in database
- If NOT exists ‚Üí Calls Gemini AI to generate new insights
- Creates new `IndustryInsight` record with:
  - Industry name
  - AI-generated data (salaries, trends, skills)
  - `nextUpdate`: Set to 7 days from now
- Updates user's profile with selected industry

**Key Timestamp Logic:**

```javascript
nextUpdate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
// Current time + 7 days in milliseconds
```

---

### 2. **`actions/dashboard.js`** - AI Insight Generation

```javascript
export const generateAIInsights = async(industry);
```

**What it does:**

- Takes an industry name (e.g., "Software Engineering")
- Sends a prompt to Gemini API asking for:
  - Salary ranges (5+ roles with min/median/max)
  - Growth rate percentage
  - Demand level (High/Medium/Low)
  - Top skills
  - Market outlook (Positive/Neutral/Negative)
  - Key trends
  - Recommended skills
- Parses JSON response from Gemini
- Returns structured data object

**Current Model:** `gemini-2.5-flash`

---

### 3. **`lib/inngest/function.js`** - Weekly Auto-Refresh

```javascript
export const generateIndustryInsights = inngest.createFunction(
  { name: "Generate Industry Insights" },
  { cron: "0 0 * * 0" }, // Every Sunday at midnight
  async ({ event, step }) => { ... }
)
```

**What it does:**

- Runs automatically every Sunday at 00:00 (midnight)
- Fetches ALL industries from database
- For each industry:
  1. Generates fresh insights using Gemini
  2. Updates the database record
  3. Sets new `lastUpdated` to current time
  4. Sets new `nextUpdate` to 7 days later

**Why Inngest?**

- Reliable background job execution
- Built-in retries & error handling
- Step-based execution tracking
- No need to manage cron manually

**‚ö†Ô∏è Important:** This cron job needs to be registered in your Next.js app to actually run. Check that it's properly configured in `/api/inngest/route.js`.

---

### 4. **`dashboard-view.jsx`** - UI Display Component

**Purpose:** Pure presentation component that displays insights data.

#### üìä Recharts Usage

**Why Recharts?**

- Composable (build charts with React components)
- Responsive out of the box
- Customizable tooltips
- Lightweight

**How it works:**

1. **Data Transformation:**

```javascript
const salaryData = insights.salaryRanges.map((range) => ({
  name: range.role, // "Software Engineer"
  min: range.min / 1000, // 75000 ‚Üí 75 (for "75K")
  max: range.max / 1000, // 150000 ‚Üí 150
  median: range.median / 1000, // 110000 ‚Üí 110
}));
```

2. **Chart Structure:**

```javascript
<BarChart data={salaryData}>
  <CartesianGrid /> // Background grid
  <XAxis dataKey="name" /> // Role names on bottom
  <YAxis /> // Salary values on left
  <Tooltip /> // Hover popup
  <Bar dataKey="min" /> // First bar (light gray)
  <Bar dataKey="median" /> // Second bar (medium gray)
  <Bar dataKey="max" /> // Third bar (dark gray)
</BarChart>
```

3. **Result:** 3 bars per role showing salary range visually

#### üìÖ date-fns Usage

**Why date-fns?**

- Tree-shakable (only import what you use)
- Immutable (doesn't modify original dates)
- TypeScript support
- Modern alternative to moment.js

**Two Functions Used:**

1. **`format(date, pattern)`** - Absolute Date

```javascript
format(new Date(insights.lastUpdated), 'dd/MM/yyyy');
// Input: 2026-01-27T10:30:00.000Z
// Output: "27/01/2026"
```

2. **`formatDistanceToNow(date, options)`** - Relative Time

```javascript
formatDistanceToNow(new Date(insights.nextUpdate), { addSuffix: true });
// If nextUpdate is Feb 3, 2026 (7 days from now):
// Output: "in 7 days"

// If nextUpdate was yesterday:
// Output: "1 day ago"
```

**Where displayed:**

- "Last updated: 27/01/2026" ‚Üê `format()`
- "Next update in 3 days" ‚Üê `formatDistanceToNow()`

---

## üîÑ Weekly Renewal System - How It Works

### Current Implementation

The weekly refresh happens in **`lib/inngest/function.js`**:

```javascript
{
  cron: '0 0 * * 0';
} // Cron expression
```

**Breakdown:**

- `0` - Minute (0 = start of hour)
- `0` - Hour (0 = midnight)
- `*` - Day of month (any)
- `*` - Month (any)
- `0` - Day of week (0 = Sunday)

**Result:** Runs every Sunday at 00:00

### Execution Flow

```
Sunday 00:00
    ‚Üì
Inngest triggers cron job
    ‚Üì
Fetch all industries from DB
    ‚Üì
For each industry:
    1. Call Gemini API with prompt
    2. Parse JSON response
    3. Update database:
       - New insights data
       - lastUpdated = now
       - nextUpdate = now + 7 days
    ‚Üì
User sees fresh data on next dashboard visit
```

### Database Schema (Prisma)

```prisma
model IndustryInsight {
  id          String   @id @default(cuid())
  industry    String   @unique

  // AI-generated data
  salaryRanges      Json
  growthRate        Float
  demandLevel       String
  topSkills         String[]
  marketOutlook     String
  keyTrends         String[]
  recommendedSkills String[]

  // Timestamp tracking
  lastUpdated DateTime @default(now())
  nextUpdate  DateTime

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

### Why NOT in Dashboard Component?

The dashboard is a **client component** (`"use client"`) that only:

- Receives pre-fetched data as props
- Displays the data visually
- Has NO logic for checking/updating

**Separation of Concerns:**

- ‚úÖ Server Actions (`actions/`) = Data fetching & mutations
- ‚úÖ Inngest Functions (`lib/inngest/`) = Background jobs
- ‚úÖ UI Components (`_component/`) = Presentation only

---

## üé® UI Component Breakdown

### 4 Metric Cards

1. **Market Outlook**
   - Icon changes based on value (‚ÜóÔ∏è/‚Üí/‚ÜòÔ∏è)
   - Color changes (green/yellow/red)
   - Shows next update time

2. **Industry Growth**
   - Percentage value
   - Progress bar visualization
   - Max value = 100%

3. **Demand Level**
   - Text value (High/Medium/Low)
   - Color-coded bar (green/yellow/red)

4. **Top Skills**
   - Array of skills
   - Displayed as badges
   - Wraps to multiple rows

### Salary Chart Features

- **Responsive**: Adjusts to screen width
- **Interactive**: Hover shows exact values
- **Comparison**: 3 bars per role (min/median/max)
- **Scale**: Automatically scales Y-axis
- **Custom Tooltip**: Formatted with "$" and "K"

### Trends & Skills Section

- **Left Card**: Bullet list of key trends
- **Right Card**: Recommended skills as badges
- **Responsive**: Stacks on mobile (1 column)

---

## üöÄ How to Test Weekly Updates Manually

If you want to test the weekly update without waiting:

```bash
# Call the Inngest function directly
curl -X POST http://localhost:3000/api/inngest \
  -H "Content-Type: application/json" \
  -d '{"name": "app/industry.insights.refresh"}'
```

Or temporarily change the cron schedule:

```javascript
// In function.js, change to run every minute for testing
{
  cron: '* * * * *';
}
```

---

## üîß Common Issues & Solutions

### Issue 1: Insights Not Updating

**Check:**

- Is Inngest properly configured?
- Is `/api/inngest/route.js` working?
- Check Inngest dashboard for job logs

### Issue 2: Chart Not Displaying

**Check:**

- Is `salaryRanges` an array?
- Does each item have `min`, `max`, `median`?
- Are values numbers (not strings)?

### Issue 3: Dates Showing Wrong

**Check:**

- Is `lastUpdated` a valid Date?
- Is `nextUpdate` 7 days in future?
- Timezone settings

---

## üìä Data Structure Example

```json
{
  "industry": "Software Engineering",
  "salaryRanges": [
    {
      "role": "Junior Developer",
      "min": 50000,
      "max": 80000,
      "median": 65000,
      "location": "USA"
    },
    {
      "role": "Senior Developer",
      "min": 90000,
      "max": 150000,
      "median": 120000,
      "location": "USA"
    }
  ],
  "growthRate": 12.5,
  "demandLevel": "High",
  "topSkills": ["JavaScript", "React", "Node.js", "Python", "AWS"],
  "marketOutlook": "Positive",
  "keyTrends": [
    "AI integration in development tools",
    "Remote work becoming standard",
    "Increased focus on cloud-native development"
  ],
  "recommendedSkills": ["TypeScript", "Docker", "Kubernetes", "GraphQL"],
  "lastUpdated": "2026-01-27T00:00:00.000Z",
  "nextUpdate": "2026-02-03T00:00:00.000Z"
}
```

---

## üéØ Summary

1. **Onboarding** ‚Üí User selects industry ‚Üí Gemini generates insights
2. **Dashboard** ‚Üí Displays insights with Recharts & date-fns
3. **Weekly Cron** ‚Üí Inngest refreshes all industries every Sunday
4. **User sees** ‚Üí Fresh, relevant data updated automatically

**Key Technologies:**

- **Gemini AI** - Content generation
- **Inngest** - Background job orchestration
- **Recharts** - Data visualization
- **date-fns** - Date formatting
- **Prisma** - Database ORM
- **Next.js 13+** - Server actions & app router
